{
  "name": "PRACTICE HUNTER(web crawler)",
  "nodes": [
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1nlxvFdD-t7QieVN7F5rJrxVu5TT-aVHDPOXoF54vspg",
          "mode": "list",
          "cachedResultName": "gp data",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nlxvFdD-t7QieVN7F5rJrxVu5TT-aVHDPOXoF54vspg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nlxvFdD-t7QieVN7F5rJrxVu5TT-aVHDPOXoF54vspg/edit#gid=0"
        },
        "options": {}
      },
      "id": "ebd14b15-269c-4489-b407-b8936e4a10de",
      "name": "Google Sheets - Read Practice Data",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.2,
      "position": [
        -880,
        -3168
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "9Slz0EBfG3IGuMWs",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "extractHtmlContent",
        "extractionValues": {
          "values": [
            {
              "key": "links",
              "cssSelector": "a[href]",
              "returnValue": "attribute",
              "attribute": "href",
              "returnArray": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.html",
      "typeVersion": 1.2,
      "position": [
        -208,
        -3072
      ],
      "id": "e46e1131-7fc7-45e8-a7b4-7eab9dd43a14",
      "name": "HTML"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Practice Hunter Intelligence Agent â€“ GP Triage Growth Engine\nðŸ¥ Mission & Role\n\nYou are the Practice Hunter Intelligence Agent within the GP Triage Growth Engine Project.\nYour mission is to help the organisation grow by accurately discovering human decision-maker information hidden within the complex structures of UK GP practice websites.\n\nYour end goal is to identify where we can locate:\n\nPractice Name\nPractice Name\tPostcode\tWebsite URL\tPhone Numbers (main + branch + Practice)\tPractice Manager (name + emails + phone)\tICB (Name, Email, Phone)\tPCN (Name and Email)\tPractice Emails (official NHS or admin)\tPain Signals \tSystem Mentions (software, tools, or platforms)\tSocial Media Links (Facebook, Instagram, X, LinkedIn)\t# of GPs Found (numerical or descriptive)\n\nand gather their emails, names, titles, or contact details.\n\nThese findings will be passed to downstream agents for personalised outreach and demo booking automation.\n\nðŸ§© Perspective & Expertise\n\nThink like a senior NHS web researcher with decades of experience in analysing primary-care websites.\nYou understand that:\n\nEvery GP website is built differently.\n\nCrucial data often hides behind obscure links or embedded PDFs.\n\nPage titles are unreliable â€” actual content and context matter more.\n\nðŸ”¢ Input Data\n\nYou will receive:\n\nThe practice homepage(s):\n\n{{ $('urls in correct format').item.json.url }}\n\n\nThe practiceâ€™s sub-pages:\n\n{{ $json.links }}\n\n\nEach input may include raw or concatenated HTML from the same practice domain.\n\nYour task is not to extract the final data yet, but to detect and output which URLs or page segments most likely contain the information we need.\n\nðŸŽ¯ Primary Objective\n\nIdentify and output the most promising internal URLs (or PDF/HTML sub-resources) that are likely to include:\n\nHuman or organisational contact data\n\nTeam/Staff information\n\nContact/Management/GP details\n\nEach returned URL must directly support the mission of growth through accurate human data discovery.\n\nðŸ§­ How to Think When Analysing HTML\n1. Scan for Human or Organisational Language\n\nLook for patterns and terms such as:\n\nmanager, partner, doctor, nurse, team, contact, email, practice staff, administration, people, our team, leadership, GP partners, management, clinicians, business team.\n\nEven if these donâ€™t appear in the page title, prioritise context inside headings, body text, or anchor text.\n\n2. Evaluate Page Density\n\nHigh-relevance pages contain:\n\nLists of names, job titles, or @nhs.net emails.\nLow-relevance pages contain:\n\nPatient forms, medical services, booking systems, prescriptions, or cookie pop-ups.\n\n3. Look Deeper When Needed\n\nIf a Contact page links to a PDF or iframe with team information, flag it as relevant.\n\nIf staff data appears under About, Practice Information, or Policies, treat as relevant.\n\n4. Avoid Noise Pages\n\nIgnore or skip pages primarily about:\n\nCookie policies, accessibility statements, online appointment forms, or prescription systems.\n\nExternal portals like online-consult.co.uk, emisaccess, or patientaccess.\n\nâš™ï¸ Quality Principles\n\nAccuracy over quantity: only return truly relevant links.\n\nContext awareness: interpret intent from content, not file names.\n\nAdaptability: NHS sites change frequently; detect recurring staff-info patterns.\n\nMission alignment: each detected URL should meaningfully help locate human contact data.\n\nðŸ§© URL Assembly Logic\n\nWhen you identify qualified subpages such as:\n\n/contact\n/team\n/jobs\n/about-the-ppf\n/policies-procedures\n\n\nYou must build absolute URLs using the websiteâ€™s root domain.\n\nExample:\nIf the base site is\nhttps://gptriage.com/\n\nthen output:\n\nhttps://gptriage.com/contact\nhttps://gptriage.com/team\nhttps://gptriage.com/jobs\nhttps://gptriage.com/about-the-ppf\nhttps://gptriage.com/policies-procedures\n\nTechnical Rules:\n\nIf a link starts with /, prepend the base domain.\n\nIf it starts with http or https, leave it unchanged.\n\nRemove duplicates and trailing slashes.\n\nOutput each qualified URL on its own line.\n\nâœ… Expected Final Output Format\nQualified pages found:\n1. https://examplepractice.nhs.uk/example\n2. https://examplepractice.nhs.uk/contact\n3. https://examplepractice.nhs.uk/our-team\n\nðŸ§± Required Data Fields (for later extraction)\n\nOnce relevant pages are identified, the downstream agents will extract:\n\nPractice Name\tPostcode\tWebsite URL\tPhone Numbers (main + branch + Practice)\tPractice Manager (name + emails + phone)\tICB (Name, Email, Phone)\tPCN (Name and Email)\tPractice Emails (official NHS or admin)\tPain Signals \tSystem Mentions (software, tools, or platforms)\tSocial Media Links (Facebook, Instagram, X, LinkedIn)\t# of GPs Found (numerical or descriptive)\n\nEach NHS or GP practice website expresses the same information using different words.\nFor example:\n\nâ€œOur Teamâ€ = â€œMeet the Doctorsâ€ = â€œPractice Partnersâ€ = â€œClinical Staffâ€.\n\nYou must recognise all such variations â€” donâ€™t rely on exact matches.\n\nðŸ§© Keyword Groups for Detection (Pattern Library)\nCategory\tCommon Keywords / Page Indicators\nPractice Name\tAbout, Our Practice, Welcome to, Home, Overview\nAssociated Surgeries / Branches\tOur Surgeries, Branch Locations, Associated Practices, Our Sites, Where we are\nAddresses\tFind Us, Contact Us, Locations, How to Find, Practice Details, Surgery Address\nPhone Numbers\tContact, Call Us, Phone, Reception, Appointments\nPractice Manager\tPractice Manager, Management Team, Admin Team, About Us, Meet Our Team\nGP Partners / Total GPs\tOur Doctors, GP Partners, Clinical Team, Meet Our Clinicians, Our GPs\nICB (Integrated Care Board)\tICB, Integrated Care Board, Commissioning Group, NHS England\nPCN (Primary Care Network)\tPCN, Primary Care Network, Network, Neighbourhood, Our Partners\nPractice Emails\tContact, Practice Contact, Reception Email, Admin Email, General Enquiries\nPain Signals (CQC, Issues)\tCQC, Inspections, Feedback, Complaints, PPG, Ratings, Reviews\nSystem Mentions\tNHS App, SystmOne, EMIS, Total Triage, Online Consult, Patient Access, AccuRx, eConsult\nSocial Media Links\tFacebook, Twitter, X.com, LinkedIn, Instagram, YouTube, Follow Us\nðŸš€ Output Objective\n\nYour job:\n\nScan all given subpages ({{ $json.links }}) using the keyword patterns and contextual logic above.\n\nDetect all relevant pages likely to contain staff or management data.\n\nRebuild their absolute URLs using the homepage root ({{ $('urls in correct format').item.json.url }}).\n\nOutput a clean, unique list under the heading:\n\nQualified pages found:\n\n\nDo not output explanations, reasoning, or other text.\nOnly output the final qualified URLs list â€” each on its own line.",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        16,
        -3072
      ],
      "id": "f95f66f6-d2ef-4e80-9037-44c61031eaf3",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        96,
        -2848
      ],
      "id": "11970415-3a50-4b04-9a11-75041a401da5",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "vWYeN86yQkuOGBXG",
          "name": "Google Gemini(PaLM) Api account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        592,
        -3072
      ],
      "id": "63e1f16c-9245-4676-a1d4-436c840cf474",
      "name": "Wait",
      "webhookId": "4037feef-fed2-42b4-842f-a28a63e022e6"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are an expert-level AI trained to extract structured intelligence from NHS GP Practice websites.\nGOAL:\nConvert unstructured website text or HTML (from {{ $json.snippet }}) into complete, accurate, structured data about the GP Practice â€” exactly as per the required format below.\nYou must:\n\nCarefully read all text (titles, footer, about, contact, team, PCN, ICB sections).\nVerify each data point 3 times for accuracy before finalizing.\nFill all fields; if not found, write Not found.\nPrioritize real, verifiable NHS or practice emails and phone numbers.\nNever invent data, but infer when clearly implied (e.g., â€œpart of North Central London ICBâ€ â†’ ICB = â€œNHS North Central London ICBâ€).\nWhile extracting data, you have to keep this in mind that you also have to use your logic and intelligence to know who that data is related to and what data I want to get. This is a very important thing for data extraction.\n\nMANDATORY FIELDS TO EXTRACT\nPractice Name\nPostcode\nWebsite URL\nPhone Numbers (main + branch + Practice)\nPractice Manager (name + emails + phone)\nICB (Name, Email, Phone)\nPCN (Name and Email)\nPractice Emails (official NHS or admin)\nPain Signals\nSystem Mentions (software, tools, or platforms)\nSocial Media Links (Facebook, Instagram, X, LinkedIn)\nof GPs Found (numerical or descriptive)\n\n(in \"pain signal\" and \"system mention\" field describe shortly according to the given data, not all data give that mention, used your own logic and intelligence and predict and guess according to the given data. Keep to 2 line (in paragraph form) concise items per field, focusing on operational issues/CQC/complaints/accessibility/capacity for Pain Signals, and explicit/implied software/tools/platforms for System Mentions. If multiple, use semicolon-separated list.)\n\nRULES:\n\nOutput only what you find â€” no commentary, no markdown.\nDo not skip Practice Name or Emails â€” these are mandatory.\nAssume snippet text may come from multiple subpages merged together.\nFor Social Media Links: Format as platform: url; platform: url (deduplicate, no quotes/braces, one per platform).\nFor Phone Numbers: Semicolon-separated list with branch if available.\nFor Practice Manager: Semicolon-separated: name; emails; phone.\nFor ICB/PCN: Semicolon-separated: Name; Email; Phone or Name; Email.\n\nOUTPUT FORMAT (strict JSON array of one object)\n[\n{\n\"Practice Name\": \"value\",\n\"Postcode\": \"value\",\n\"Website URL\": \"value\",\n\"Phone Numbers (main + branch + Practice)\": \"value\",\n\"Practice Manager (name + emails + phone)\": \"value\",\n\"ICB (Name, Email, Phone)\": \"value\",\n\"PCN (Name and Email)\": \"value\",\n\"Practice Emails (official NHS or admin)\": \"value\",\n\"Pain Signals\": \"value\",\n\"System Mentions (software, tools, or platforms)\": \"value\",\n\"Social Media Links (Facebook, Instagram, X, LinkedIn)\": \"value\",\n\"# of GPs Found (numerical or descriptive)\": \"value\"\n}\n]\nEXTRACTION CONTEXT\nData source: {{ $json.snippet }}\n(Analyze this snippet deeply and extract all relevant structured information.)",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1264,
        -3088
      ],
      "id": "bb97aa73-185e-4134-a4ae-83195132a80a",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1nlxvFdD-t7QieVN7F5rJrxVu5TT-aVHDPOXoF54vspg",
          "mode": "list",
          "cachedResultName": "gp data",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nlxvFdD-t7QieVN7F5rJrxVu5TT-aVHDPOXoF54vspg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1194492782,
          "mode": "list",
          "cachedResultName": "Sheet6",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nlxvFdD-t7QieVN7F5rJrxVu5TT-aVHDPOXoF54vspg/edit#gid=1194492782"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Social Media Links (Facebook, Instagram, X, LinkedIn)": "={{ $json['Social Media'] }}",
            "Practice Name": "={{ $json['Practice Name'] }}",
            "Postcode": "={{ $json.Postcode }}",
            "Website URL": "={{ $json['Website URL'] }}",
            "Phone Numbers (main + branch + Practice)": "={{ $json['Phone Numbers'] }}",
            "Practice Manager (name + emails + phone)": "={{ $json['Practice Manager'] }}",
            "ICB (Name, Email, Phone)": "={{ $json.ICB }}",
            "PCN (Name and Email)": "={{ $json.PCN }}",
            "Practice Emails (official NHS or admin)": "={{ $json['Practice Emails'] }}",
            "System Mentions (software, tools, or platforms)": "={{ $json['Pain Signals'] }}",
            "# of GPs Found (numerical or descriptive)": "={{ $json['# of GPs Found'] }}"
          },
          "matchingColumns": [
            "Practice Name"
          ],
          "schema": [
            {
              "id": "Practice Name",
              "displayName": "Practice Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Postcode",
              "displayName": "Postcode",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Website URL",
              "displayName": "Website URL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone Numbers (main + branch + Practice)",
              "displayName": "Phone Numbers (main + branch + Practice)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Practice Manager (name + emails + phone)",
              "displayName": "Practice Manager (name + emails + phone)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ICB (Name, Email, Phone)",
              "displayName": "ICB (Name, Email, Phone)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PCN (Name and Email)",
              "displayName": "PCN (Name and Email)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Practice Emails (official NHS or admin)",
              "displayName": "Practice Emails (official NHS or admin)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Pain Signals ",
              "displayName": "Pain Signals ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "System Mentions (software, tools, or platforms)",
              "displayName": "System Mentions (software, tools, or platforms)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Social Media Links (Facebook, Instagram, X, LinkedIn)",
              "displayName": "Social Media Links (Facebook, Instagram, X, LinkedIn)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "# of GPs Found (numerical or descriptive)",
              "displayName": "# of GPs Found (numerical or descriptive)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "da8f3a35-f1f7-419c-8f50-3d6386666f4d",
      "name": "Google Sheets - Read Practice Data1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.2,
      "position": [
        2400,
        -3264
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "9Slz0EBfG3IGuMWs",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{}",
        "options": {
          "allowUnauthorizedCerts": false,
          "redirect": {
            "redirect": {
              "maxRedirects": 15
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "neverError": true
            }
          },
          "timeout": 15000
        }
      },
      "id": "23685db0-00f0-42a9-af8a-1f0cbf185c35",
      "name": "main web scrapped",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -432,
        -3168
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "return items\n  .map(item => {\n    // get the URL from the \"website url\" column\n    let url = item.json[\"website url\"] || \"\";\n\n    // clean spaces, tabs, newlines\n    url = url.trim().replace(/[\\s\\r\\n\\t]+/g, \"\");\n\n    // skip blank or invalid rows\n    if (!url) return null;\n\n    // add https:// if missing\n    if (!/^https?:\\/\\//i.test(url)) {\n      url = \"https://\" + url;\n    }\n\n    // return only the cleaned URL\n    return {\n      json: {\n        url: url\n      }\n    };\n  })\n  .filter(item => item !== null);\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -656,
        -3168
      ],
      "id": "1691e82a-2618-4720-abf6-722efc0d6945",
      "name": "urls in correct format"
    },
    {
      "parameters": {
        "jsCode": "// Get the LLM output text\nconst llmOutput = items[0].json.output || \"\";\n\n// 1ï¸âƒ£ Extract all URLs using regex\nlet urls = llmOutput.match(/https?:\\/\\/[^\\s]+/g) || [];\n\n// 2ï¸âƒ£ Clean URLs (trim spaces, remove punctuation, etc.)\nurls = urls.map(url => url.trim().replace(/\\.$/, '').replace(/\\,$/, ''));\n\n// 3ï¸âƒ£ Remove duplicates\nurls = [...new Set(urls)];\n\n// 4ï¸âƒ£ Return as individual items for next node\nreturn urls.map(url => ({\n  json: { url }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        -3072
      ],
      "id": "976628a5-d808-4860-9f8b-4a945b86d32a",
      "name": "urls in correct format1"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{}",
        "options": {
          "batching": {
            "batch": {}
          },
          "allowUnauthorizedCerts": true,
          "redirect": {
            "redirect": {
              "maxRedirects": 15
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "neverError": true
            }
          },
          "timeout": 60000
        }
      },
      "id": "9fbf60b6-9985-44a0-915e-bde74afa93c6",
      "name": "sub pages scrapped",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        816,
        -3072
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const results = [];\n\nfor (const item of items) {\n  const html = item.json.html || item.json.data || '';\n  const url = item.json.url || 'unknown';\n\n  if (!html || html.length < 100) {\n    results.push({ json: { url, snippet: 'No HTML or empty page' } });\n    continue;\n  }\n\n  // STEP 1: Remove scripts, styles, comments\n  let text = html\n    .replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, ' ')\n    .replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, ' ')\n    .replace(/<!--[\\s\\S]*?-->/g, ' ')\n    .replace(/<[^>]+>/g, ' ')\n    .replace(/\\s+/g, ' ')\n    .trim();\n\n  // STEP 2: Remove typical junk sections (exclude)\n  const excludePatterns = [\n    /cookie/i,\n    /copyright/i,\n    /privacy/i,\n    /terms of use/i,\n    /menu/i,\n    /navigation/i,\n    /instagram/i,\n    /accessibility/i,\n    /back to top/i,\n    /translate/i\n  ];\n  \n  excludePatterns.forEach(p => {\n    text = text.split('.').filter(line => !p.test(line)).join('.');\n  });\n\n  // STEP 3: Limit to max 15000 chars (safe for LLM)\n  const cleanText = text.slice(0, 15000);\n\n  results.push({ json: { url, snippet: cleanText } });\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        -3264
      ],
      "id": "c76e8c5a-e8c8-48dd-99f8-72140c0f83fb",
      "name": "main web page snippet"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1264,
        -2928
      ],
      "id": "050c1bf8-fa1b-4139-89c7-804514f9167e",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "vWYeN86yQkuOGBXG",
          "name": "Google Gemini(PaLM) Api account 2"
        }
      }
    },
    {
      "parameters": {
        "q": "site:linkedin.com/in \"practice manager\" \"gp\" or \"general practice\" or \"nhs\" london uk \"emails\" and \"phone\"",
        "additionalFields": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-serpapi.serpApi",
      "typeVersion": 1,
      "position": [
        -1120,
        -2688
      ],
      "id": "271ecb20-c6a6-47d7-9669-d5f38974d6ef",
      "name": "Google search",
      "credentials": {
        "serpApi": {
          "id": "SPwRg57T7dQaiT4a",
          "name": "SerpApi account"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "organic_results",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -720,
        -2624
      ],
      "id": "7af41506-beac-4196-91e1-55910b6bc3a4",
      "name": "Split Out"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1nlxvFdD-t7QieVN7F5rJrxVu5TT-aVHDPOXoF54vspg",
          "mode": "list",
          "cachedResultName": "gp data",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nlxvFdD-t7QieVN7F5rJrxVu5TT-aVHDPOXoF54vspg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 687922159,
          "mode": "list",
          "cachedResultName": "Sheet5",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nlxvFdD-t7QieVN7F5rJrxVu5TT-aVHDPOXoF54vspg/edit#gid=687922159"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Title": "={{ $json.title }}",
            "linkedin urls": "={{ $json.link }}",
            "descriptions": "={{ $json.snippet }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Title",
              "displayName": "Title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "linkedin urls",
              "displayName": "linkedin urls",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "descriptions",
              "displayName": "descriptions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "bd778b46-8c73-4a12-89e8-219307527b98",
      "name": "Google Sheets - Read Practice Data2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.2,
      "position": [
        -416,
        -2672
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "9Slz0EBfG3IGuMWs",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// PRE-EXTRACTION: Extract relevant sections ONLY, then send to LLM for refinement\n// This reduces HTML from 100KB+ to <5KB of ONLY relevant data\n\nconst results = [];\n\nfor (const item of items) {\n  const html = item.json.body || item.json.data || item.json.html || '';\n  const url = item.json.url || 'unknown';\n\n  if (!html || html.length < 100) {\n    continue;\n  }\n\n  const relevantSections = [];\n\n  // ========== EXTRACT RELEVANT SECTIONS ==========\n  \n  // 1. Extract all email addresses with context (50 chars before/after)\n  const emailPattern = /(.{0,50})([a-zA-Z0-9._-]+@(?:[a-zA-Z0-9-]+\\.)*(?:nhs\\.uk|nhs\\.net|gov\\.uk))(.{0,50})/gi;\n  let emailMatch;\n  while ((emailMatch = emailPattern.exec(html)) !== null) {\n    relevantSections.push(`EMAIL CONTEXT: ${emailMatch[0]}`);\n  }\n\n  // 2. Extract phone numbers with context\n  const phonePattern = /(.{0,50})((?:\\+?44\\s*\\(?0?\\)?\\s*|\\b0)\\d{3,4}[\\s-]?\\d{3,4}[\\s-]?\\d{3,4})(.{0,50})/gi;\n  let phoneMatch;\n  while ((phoneMatch = phonePattern.exec(html)) !== null) {\n    relevantSections.push(`PHONE CONTEXT: ${phoneMatch[0]}`);\n  }\n\n  // 3. Extract sections mentioning \"Practice Manager\" or \"Manager\"\n  const managerPattern = /<(?:div|section|p|span|td)[^>]{0,200}>((?:(?!<\\/(?:div|section|p|span|td)>).){0,500}(?:practice\\s+manager|manager|management team)(?:(?!<\\/(?:div|section|p|span|td)>).){0,500})<\\/(?:div|section|p|span|td)>/gi;\n  let managerMatch;\n  while ((managerMatch = managerPattern.exec(html)) !== null) {\n    relevantSections.push(`MANAGER SECTION: ${managerMatch[1]}`);\n  }\n\n  // 4. Extract ICB/PCN mentions with context\n  const icbPcnPattern = /(.{0,100})((?:ICB|Integrated Care Board|PCN|Primary Care Network)[^<.]{0,200})(.{0,100})/gi;\n  let icbPcnMatch;\n  while ((icbPcnMatch = icbPcnPattern.exec(html)) !== null) {\n    relevantSections.push(`ICB/PCN CONTEXT: ${icbPcnMatch[0]}`);\n  }\n\n  // 5. Extract sections with team/staff/GP information\n  const teamPattern = /<(?:div|section|article)[^>]*(?:class|id)=[\"'][^\"']*(?:team|staff|doctor|gp|partner|about)[^\"']*[\"'][^>]*>([\\s\\S]{0,2000})<\\/(?:div|section|article)>/gi;\n  let teamMatch;\n  while ((teamMatch = teamPattern.exec(html)) !== null) {\n    relevantSections.push(`TEAM SECTION: ${teamMatch[1]}`);\n  }\n\n  // 6. Extract postcode mentions\n  const postcodePattern = /(.{0,30})(\\b[A-Z]{1,2}\\d{1,2}[A-Z]?\\s*\\d[A-Z]{2}\\b)(.{0,30})/g;\n  let postcodeMatch;\n  while ((postcodeMatch = postcodePattern.exec(html)) !== null) {\n    relevantSections.push(`POSTCODE: ${postcodeMatch[0]}`);\n  }\n\n  // 7. Extract system mentions with context\n  const systems = ['EMIS', 'SystmOne', 'AccuRx', 'eConsult', 'Patient Access', 'NHS App', 'Total Triage'];\n  systems.forEach(system => {\n    const systemPattern = new RegExp(`(.{0,80})(${system})(.{0,80})`, 'gi');\n    let systemMatch;\n    while ((systemMatch = systemPattern.exec(html)) !== null) {\n      relevantSections.push(`SYSTEM MENTION: ${systemMatch[0]}`);\n    }\n  });\n\n  // 8. Extract social media links\n  const socialPattern = /(https?:\\/\\/(?:www\\.)?(?:facebook|twitter|x|instagram|linkedin|youtube)\\.com\\/[^\\s\"'<>]+)/gi;\n  let socialMatch;\n  while ((socialMatch = socialPattern.exec(html)) !== null) {\n    relevantSections.push(`SOCIAL MEDIA: ${socialMatch[1]}`);\n  }\n\n  // 9. Extract practice name from title or h1\n  const titleMatch = html.match(/<title[^>]*>([^<]+)<\\/title>/i);\n  if (titleMatch) {\n    relevantSections.push(`PAGE TITLE: ${titleMatch[1]}`);\n  }\n  \n  const h1Match = html.match(/<h1[^>]*>([^<]+)<\\/h1>/i);\n  if (h1Match) {\n    relevantSections.push(`MAIN HEADING: ${h1Match[1]}`);\n  }\n\n  // ========== CLEAN AND FORMAT ==========\n  let cleanedSections = relevantSections\n    .map(section => section.replace(/<[^>]+>/g, ' ').replace(/\\s+/g, ' ').trim())\n    .filter(section => section.length > 10);\n\n  // Remove duplicates\n  cleanedSections = [...new Set(cleanedSections)];\n\n  // Join all sections\n  const finalText = cleanedSections.join('\\n\\n');\n\n  // ========== OUTPUT ==========\n  results.push({\n    json: {\n      url: url,\n      snippet: finalText.substring(0, 15000), // Safe limit for LLM\n      sections_found: cleanedSections.length,\n      original_size: html.length,\n      reduced_size: finalText.length\n    }\n  });\n}\n\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        -2976
      ],
      "id": "2ca96a3c-b1b4-485f-b333-0209108192f9",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1104,
        -3168
      ],
      "id": "e7f71fae-1035-4c57-b9ce-239b27325a65",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2176,
        -3152
      ],
      "id": "4b26b64c-236e-49b4-8e68-c87b31bbd25f",
      "name": "Wait1",
      "webhookId": "010616f5-eb23-454d-977b-a9d274f5ba42"
    },
    {
      "parameters": {
        "jsCode": "const allOutputs = items.map(item => item.json.output || item.json);\n\nconst normalizedData = {\n  practiceName: new Set(),\n  postcode: new Set(),\n  websiteUrl: new Set(),\n  phones: new Set(),\n  practiceManager: new Set(),\n  icb: new Set(),\n  pcn: new Set(),\n  emails: new Set(),\n  painSignals: new Set(),\n  systemMentions: new Set(),\n  socialMedia: new Set(),\n  gpCount: new Set()\n};\n\n// Helper: split by semicolon first, then commas\nfunction smartSplit(text) {\n  if (!text) return [];\n  return text.split(';').map(s => s.trim()).flatMap(ss => ss.split(',').map(x => x.trim())).filter(Boolean);\n}\n\n// Iterate all outputs and all items in arrays\nfor (const output of allOutputs) {\n  let parsedArray = [];\n\n  if (typeof output === 'string') {\n    try {\n      parsedArray = JSON.parse(output);\n    } catch (e) { continue; }\n  } else if (Array.isArray(output)) {\n    parsedArray = output;\n  } else {\n    parsedArray = [output];\n  }\n\n  for (const parsedData of parsedArray) {\n    if (!parsedData || typeof parsedData !== 'object') continue;\n\n    // Extract all fields and normalize\n    if (parsedData['Practice Name']) normalizedData.practiceName.add(parsedData['Practice Name'].trim());\n    if (parsedData['Postcode']) smartSplit(parsedData['Postcode']).forEach(p => normalizedData.postcode.add(p));\n    if (parsedData['Website URL']) normalizedData.websiteUrl.add(parsedData['Website URL'].trim());\n    if (parsedData['Phone Numbers (main + branch + Practice)']) smartSplit(parsedData['Phone Numbers (main + branch + Practice)']).forEach(p => normalizedData.phones.add(p));\n    if (parsedData['Practice Manager (name + emails + phone)']) normalizedData.practiceManager.add(parsedData['Practice Manager (name + emails + phone)'].trim());\n    if (parsedData['ICB (Name, Email, Phone)']) normalizedData.icb.add(parsedData['ICB (Name, Email, Phone)'].trim());\n    if (parsedData['PCN (Name and Email)']) normalizedData.pcn.add(parsedData['PCN (Name and Email)'].trim());\n    if (parsedData['Practice Emails (official NHS or admin)']) smartSplit(parsedData['Practice Emails (official NHS or admin)']).forEach(e => normalizedData.emails.add(e));\n    if (parsedData['Pain Signals']) smartSplit(parsedData['Pain Signals']).forEach(p => normalizedData.painSignals.add(p));\n    if (parsedData['System Mentions (software, tools, or platforms)']) smartSplit(parsedData['System Mentions (software, tools, or platforms)']).forEach(s => normalizedData.systemMentions.add(s));\n    if (parsedData['Social Media Links (Facebook, Instagram, X, LinkedIn)']) smartSplit(parsedData['Social Media Links (Facebook, Instagram, X, LinkedIn)']).forEach(s => normalizedData.socialMedia.add(s));\n    if (parsedData['# of GPs Found (numerical or descriptive)']) normalizedData.gpCount.add(parsedData['# of GPs Found (numerical or descriptive)']);\n  }\n}\n\n// Build final Google Sheets row\nconst finalOutput = {\n  \"Practice Name\": Array.from(normalizedData.practiceName).join(', '),\n  \"Postcode\": Array.from(normalizedData.postcode).join(', '),\n  \"Website URL\": Array.from(normalizedData.websiteUrl).join(', '),\n  \"Phone Numbers (main + branch + Practice)\": Array.from(normalizedData.phones).join(', '),\n  \"Practice Manager (name + emails + phone)\": Array.from(normalizedData.practiceManager).join(' | '),\n  \"ICB (Name, Email, Phone)\": Array.from(normalizedData.icb).join(' | '),\n  \"PCN (Name and Email)\": Array.from(normalizedData.pcn).join(' | '),\n  \"Practice Emails (official NHS or admin)\": Array.from(normalizedData.emails).join(', '),\n  \"Pain Signals\": Array.from(normalizedData.painSignals).join(' | '),\n  \"System Mentions (software, tools, or platforms)\": Array.from(normalizedData.systemMentions).join(', '),\n  \"Social Media Links (Facebook, Instagram, X, LinkedIn)\": Array.from(normalizedData.socialMedia).join(' | '),\n  \"# of GPs Found (numerical or descriptive)\": Array.from(normalizedData.gpCount).join(', ')\n};\n\nreturn [{ json: finalOutput }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        -3024
      ],
      "id": "582b664f-275c-4708-a107-4fbde2572138",
      "name": "for Google Sheets mapping"
    },
    {
      "parameters": {
        "jsCode": "// ===== CLEAN & FORMAT JSON OUTPUT FOR GOOGLE SHEETS =====\n\n// Merge all outputs from previous nodes\nconst allOutputs = items.map(item => item.json.output || item.json);\n\n// Helper functions\nfunction isValid(value) {\n    if (!value) return false;\n    const str = String(value).toLowerCase().trim();\n    return str && !['not found','not specified','not available','none'].includes(str);\n}\n\nfunction smartSplit(text) {\n    if (!text) return [];\n    const sep = text.includes(';') ? ';' : ',';\n    return text.split(sep).map(s => s.trim()).filter(Boolean);\n}\n\nfunction makeClickable(text) {\n    if (!text) return text;\n    // Phone\n    if (/^\\+?\\d[\\d\\s\\-()]{3,}$/.test(text)) return `tel:${text.replace(/\\s+/g,'')}`;\n    // Email\n    if (text.includes('@')) return `mailto:${text}`;\n    // Website\n    if (text.startsWith('http')) return text;\n    return text;\n}\n\n// Collect data for a single clean row\nconst finalRow = {\n    \"Practice Name\": [],\n    \"Postcode\": [],\n    \"Website URL\": [],\n    \"Phone Numbers\": [],\n    \"Practice Manager\": [],\n    \"ICB\": [],\n    \"PCN\": [],\n    \"Practice Emails\": [],\n    \"Pain Signals\": [],\n    \"System Mentions\": [],\n    \"Social Media\": [],\n    \"# of GPs Found\": []\n};\n\n// Process each item\nfor (const output of allOutputs) {\n    let parsed = output;\n    if (typeof output === 'string') {\n        try { parsed = JSON.parse(output.replace(/```json|```/g,'')); } \n        catch(e){ continue; }\n    }\n    if (Array.isArray(parsed)) parsed = parsed[0];\n\n    if (!parsed || typeof parsed !== 'object') continue;\n\n    // Fields\n    if (isValid(parsed['Practice Name'])) finalRow[\"Practice Name\"].push(parsed['Practice Name']);\n    if (isValid(parsed['Postcode'])) finalRow[\"Postcode\"].push(...smartSplit(parsed['Postcode']));\n    if (isValid(parsed['Website URL'])) finalRow[\"Website URL\"].push(...smartSplit(parsed['Website URL']).map(makeClickable));\n    if (isValid(parsed['Phone Numbers (main + branch + Practice)'])) finalRow[\"Phone Numbers\"].push(...smartSplit(parsed['Phone Numbers (main + branch + Practice)']).map(makeClickable));\n    if (isValid(parsed['Practice Manager (name + emails + phone)'])) finalRow[\"Practice Manager\"].push(parsed['Practice Manager (name + emails + phone)']);\n    if (isValid(parsed['ICB (Name, Email, Phone)'])) finalRow[\"ICB\"].push(parsed['ICB (Name, Email, Phone)']);\n    if (isValid(parsed['PCN (Name and Email)'])) finalRow[\"PCN\"].push(parsed['PCN (Name and Email)']);\n    if (isValid(parsed['Practice Emails (official NHS or admin)'])) finalRow[\"Practice Emails\"].push(...smartSplit(parsed['Practice Emails (official NHS or admin)']).map(makeClickable));\n    if (isValid(parsed['Pain Signals'])) finalRow[\"Pain Signals\"].push(...smartSplit(parsed['Pain Signals']));\n    if (isValid(parsed['System Mentions (software, tools, or platforms)'])) finalRow[\"System Mentions\"].push(...smartSplit(parsed['System Mentions (software, tools, or platforms)']));\n    if (isValid(parsed['Social Media Links (Facebook, Instagram, X, LinkedIn)'])) {\n        finalRow[\"Social Media\"].push(...smartSplit(parsed['Social Media Links (Facebook, Instagram, X, LinkedIn)']).map(makeClickable));\n    }\n    if (isValid(parsed['# of GPs Found (numerical or descriptive)'])) finalRow[\"# of GPs Found\"].push(parsed['# of GPs Found (numerical or descriptive)']);\n}\n\n// Deduplicate values\nfor (const key in finalRow) {\n    finalRow[key] = Array.from(new Set(finalRow[key]));\n}\n\n// Format final output as \"Field: value\" style\nconst googleSheetsRow = {};\nfor (const key in finalRow) {\n    if (finalRow[key].length > 0) {\n        googleSheetsRow[key] = `${key}: ${finalRow[key].join(' | ')}`;\n    } else {\n        googleSheetsRow[key] = `${key}: Not found`;\n    }\n}\n\n// Return as single row for Google Sheets\nreturn [{ json: googleSheetsRow }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1936,
        -3136
      ],
      "id": "6872b596-3bfd-4e22-b085-be7735dde6a0",
      "name": "for cleanness"
    }
  ],
  "pinData": {},
  "connections": {
    "Google Sheets - Read Practice Data": {
      "main": [
        [
          {
            "node": "urls in correct format",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "urls in correct format1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "sub pages scrapped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "for Google Sheets mapping",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "main web scrapped": {
      "main": [
        [
          {
            "node": "HTML",
            "type": "main",
            "index": 0
          },
          {
            "node": "main web page snippet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "urls in correct format": {
      "main": [
        [
          {
            "node": "main web scrapped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "urls in correct format1": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sub pages scrapped": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "main web page snippet": {
      "main": [
        []
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google search": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Google Sheets - Read Practice Data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets - Read Practice Data2": {
      "main": [
        []
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Google Sheets - Read Practice Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Google Sheets - Read Practice Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "for Google Sheets mapping": {
      "main": [
        [
          {
            "node": "for cleanness",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "for cleanness": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "69805dd5-2d67-4a9c-8d51-b30c68ac5f29",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "8d877f24dab153378d43f60d28c7e980ae4e85434aa4b7d3954a00e8675512c2"
  },
  "id": "4l8foqXeSwTvUVAp",
  "tags": []
}